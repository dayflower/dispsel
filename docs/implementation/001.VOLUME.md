# Implementation: Display Volume Control

## Overview

This document describes the implementation of display volume control functionality in dispsel using DDC/CI VCP code 0x62 (Audio Speaker Volume).

## VCP Code

- **Code**: 0x62 (Audio Speaker Volume)
- **Type**: Read/Write
- **Range**: 0 to max (typically 100, varies by monitor)

## Changes Summary

### 1. VCPCommand.swift

Added `volume` case to `VCPCode` enum:

```swift
case volume = 0x62
```

### 2. DispselError.swift

Added `invalidVolumeValue` error case for validation:

```swift
case invalidVolumeValue(value: Int, max: UInt16)
```

Error message format: `"Invalid volume value: {value}. Must be between 0 and {max}"`

### 3. VolumeCommand.swift (New)

New command that:
1. Enumerates displays
2. Selects target display based on `-d` option
3. Reads VCP 0x62 to get maximum volume supported by display
4. Validates input value is within [0, max]
5. Writes VCP 0x62 with the specified value
6. Prints success message

### 4. ListCommand.swift

Added volume reading after input source display:

```swift
do {
    let (current, max) = try DDCManager.readVCP(display: display, code: VCPCode.volume.rawValue)
    formatter.printInfo("  volume:          \(current) (max: \(max))")
} catch {
    // Silently skip if VCP read fails
}
```

### 5. main.swift

Added `VolumeCmd` struct with Swift Argument Parser configuration:
- Command name: `volume`
- Argument: `value` (Int) - volume level
- Supports global options (`-q`, `-m`, `-d`)

## CLI Usage

```bash
# Set volume to 50
dispsel volume 50

# Set volume on specific display
dispsel -d 'productNameLike=DELL' volume 75

# Set volume in quiet mode
dispsel -q volume 50
```

## Output Formats

### List Command

```
[Display #1]
  uuid:            10FF0FFF-0000-0000-7777-333311112222
  manufacturer id: DEL
  product name:    DELL U4025QW
  serial number:   999XX99
  connection:      DP -> DP
  current input:   displayport1 (0x0f)
  volume:          50 (max: 100)
```

### Volume Command

Success:
```
Target: (DEL) DELL U4025QW 999XX99
Volume set to: 50
```

## Error Handling

| Scenario | Behavior |
|----------|----------|
| Display doesn't support volume (list) | Volume line omitted |
| Display doesn't support volume (volume cmd) | Error: "Failed to read VCP code 0x62" |
| Volume value out of range | Error: "Invalid volume value: 150. Must be between 0 and 100" |

## Testing

1. `swift build` - Verify compilation
2. `dispsel list` - Check volume appears for supporting displays
3. `dispsel volume 50` - Test setting volume
4. `dispsel volume 0` - Test mute
5. `dispsel volume 999` - Test validation error
6. `dispsel help volume` - Verify help text
